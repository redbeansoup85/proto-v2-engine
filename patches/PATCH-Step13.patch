From 48c80a2970f13014bd3b80f00acfc0f62b2f8810 Mon Sep 17 00:00:00 2001
From: Seunghyun Pyo <kmidus@gmail.com>
Date: Wed, 4 Feb 2026 20:32:09 +1100
Subject: [PATCH] A-PATCH: add Step13 enforced adapter plan + tests

---
 .../contracts/step13_adapter_plan.yaml        |  6 +++++
 .../adapters/test_adapter_enforced_step13.py  | 27 +++++++++++++++++++
 2 files changed, 33 insertions(+)
 create mode 100644 core/execution/contracts/step13_adapter_plan.yaml
 create mode 100644 tests/adapters/test_adapter_enforced_step13.py

diff --git a/core/execution/contracts/step13_adapter_plan.yaml b/core/execution/contracts/step13_adapter_plan.yaml
new file mode 100644
index 0000000..34801cb
--- /dev/null
+++ b/core/execution/contracts/step13_adapter_plan.yaml
@@ -0,0 +1,6 @@
+# Step13 Adapter Enforcement Plan (LOCK-safe)
+version: v1
+notes:
+  - Additional enforced adapter validation for Step13
+  - Shadow adapters remain non-blocking
+  - Enforced adapters: fail-closed unless side_effects=True
diff --git a/tests/adapters/test_adapter_enforced_step13.py b/tests/adapters/test_adapter_enforced_step13.py
new file mode 100644
index 0000000..4085cd7
--- /dev/null
+++ b/tests/adapters/test_adapter_enforced_step13.py
@@ -0,0 +1,27 @@
+import pytest
+from core.execution.executor import ShadowAdapterError, run_adapter
+
+_VALID_REQUEST = {
+    "meta": {
+        "org_id": "org-1",
+        "site_id": "site-1",
+        "source": "unit",
+        "ts_start_iso": "2026-02-04T00:00:00Z",
+        "ts_end_iso": "2026-02-04T00:01:00Z",
+    },
+    "event": {"type": "TEST_EVENT", "payload": {}},
+    "signals": [],
+    "proposed_decision": None,
+    "human_decision": None,
+}
+
+def test_shadow_path(monkeypatch):
+    monkeypatch.setenv("SHADOW_ONLY", "true")
+    result = run_adapter(adapter_name="mock", request=_VALID_REQUEST)
+    assert isinstance(result, dict)
+    assert result["ok"] is True
+
+def test_enforced_fail_closed(monkeypatch):
+    monkeypatch.setenv("SHADOW_ONLY", "false")
+    with pytest.raises(ShadowAdapterError):
+        run_adapter(adapter_name="mock", request=_VALID_REQUEST)
-- 
2.50.1 (Apple Git-155)

