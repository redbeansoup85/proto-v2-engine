name: proto-v2-engine-ci

on:
  push:
  pull_request:

jobs:
  test:
    name: proto-v2-engine-ci-test
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: "sqlite+aiosqlite:///test.db"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python (fixed)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify change classification + governance policy (SSOT)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install pyyaml
          python -m tools.ci.verify_change_token

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install ".[test]"

      - name: Run tests
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y sqlite3

          DB="$PWD/infra/api/test.db"
          rm -f "$DB"
          sqlite3 "$DB" "PRAGMA user_version;" >/dev/null

          export DATABASE_URL="sqlite+aiosqlite:///$DB"

          python -m py_compile infra/api/alembic/env.py
          python -m alembic -c infra/api/alembic.ini -q upgrade head

          make test
