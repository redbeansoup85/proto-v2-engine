name: Design Gate

on:
  pull_request:
    branches: [main]

jobs:
  pr-body-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce PR body includes DESIGN_ARTIFACT and STAGE
        run: |
          BODY="${{ github.event.pull_request.body }}"
          if [[ ! "$BODY" =~ "DESIGN_ARTIFACT:" ]]; then
            echo "Fail-Closed: PR body missing DESIGN_ARTIFACT:" >&2
            exit 1
          fi
          if [[ ! "$BODY" =~ "STAGE:" ]]; then
            echo "Fail-Closed: PR body missing STAGE:" >&2
            exit 1
          fi

  registry-hash-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Patch registry hashes (write) then fail if diff exists
        run: |
          python tools/patch_registry_hashes.py Judgment_Data/registry/schema_registry.jsonl Judgment_Data/registry/artifacts_registry.jsonl --base Judgment_Data --write
          if ! git diff --quiet -- Judgment_Data/registry/schema_registry.jsonl Judgment_Data/registry/artifacts_registry.jsonl; then
            echo "Fail-Closed: registry hashes were outdated. Commit the patched files." >&2
            git diff -- Judgment_Data/registry/schema_registry.jsonl Judgment_Data/registry/artifacts_registry.jsonl || true
            exit 1
          fi

  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install pytest
      - run: pytest -q

  phase1-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install runtime deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install alembic aiosqlite sqlalchemy pytest

      - name: Run Phase-1 LOCK verify
        run: |
          chmod +x scripts/lock/phase1_verify.sh
          ./scripts/lock/phase1_verify.sh
