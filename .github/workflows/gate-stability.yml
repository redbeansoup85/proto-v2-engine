name: gate-stability

on:
  pull_request:
  push:

    tags:
      - 'v*-lock-stable'
      - 'v*-lock-stable.*'

jobs:
  gate-stability:
    name: gate-stability
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: .
      AURALIS_AUDIT_PATH: var/logs/audit_sentinel.jsonl
      AURALIS_GENESIS_PATH: var/seal/GENESIS.yaml
      METAOS_CI_DETERMINISTIC_CONSUMER: "1"   # ✅ 추가 (CI determinism 강제)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml "jsonschema>=4.18"

      - name: Prepare fixtures (CI)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p var/local_llm var/logs var/seal

          # Minimal snapshot fixture expected by replay_sentinel_pipeline.py
          cat > var/local_llm/snapshot.json <<'JSON'
          {
            "symbol": "BTCUSDT",
            "ts": "1970-01-01T00:00:00Z",
            "price": 0.0,
            "funding": 0.0,
            "open_interest": 0.0
          }
          JSON

      - name: Run replay A/B + strict gate stability
        shell: bash
        env:
          METAOS_CI_DETERMINISTIC_CONSUMER: "1"
        run: |
          set -euo pipefail
          bash scripts/run_replay_stability.sh ci
