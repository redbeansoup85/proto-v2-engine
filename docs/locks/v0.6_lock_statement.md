# v0.6 LOCK STATEMENT — Approval Queue + File Persistence + No-Bypass Transition Gate

**Artifact:** Proto Meta Engine — Constitutional Boundary (v0.6)  
**Status:** LOCK CANDIDATE  
**Tag:** `v0.6-lock-candidate`  
**Branch:** `v0.6-approval-queue`

---

## 1. Scope

This lock statement governs the v0.6 baseline of the constitutional boundary for Proto Meta Engine, including:

- Approval Queue as the source-of-truth for approval state.
- File-backed persistence for DPA and approvals (append-only JSONL).
- No-bypass enforcement for `/v1/constitutional/transition`.
- DEV/LOCAL-only utilities (`__debug_seed`, noop apply port) with explicit environment gating.

This baseline is intended for single-process demo/local validation and auditability, not for multi-process or distributed correctness.

---

## 2. Non-Negotiable Invariants

### 2.1 No-Bypass Approval Gate

For any request where `approval.decision == "APPROVE"`:

- `approval_id` is mandatory.
- The system MUST resolve approval state from the Approval Queue using `approval_id`.
- The system MUST reject the transition if:
  - the `approval_id` is not found, OR
  - the latest approval status is not `APPROVED`, OR
  - `{dpa_id,event_id}` does not match the request `{dpa_id,event_id}`.

### 2.2 Persistence (Append-Only)

When `METAOS_STORAGE=file`:

- The system MUST append records to:
  - `var/metaos/approvals.jsonl`
  - `var/metaos/dpa.jsonl`
- No in-place mutation is permitted in v0.6 (event-sourcing style append only).
- Runtime data directory MUST be excluded from git tracking.

### 2.3 Fail-Closed Apply Boundary

- In non-DEV/LOCAL environments, apply MUST remain fail-closed unless an explicit apply port is provided.
- Any DEV/LOCAL apply port MUST be side-effect-free unless a higher governance layer explicitly authorizes side effects.

---

## 3. Environment Gating

- `__debug_seed` endpoint MUST be disabled outside `METAOS_ENV in {"dev","local"}`.
- Noop apply port is permitted only in `METAOS_ENV in {"dev","local"}` to complete E2E verification without production side effects.

---

## 4. Acceptance Criteria (LOCK Tests)

v0.6 is lock-ready only if all conditions hold:

1) **No-bypass enforced**  
   `/transition` with `APPROVE` and missing/invalid `approval_id` returns 4xx (never silent pass).

2) **File persistence verified** (`METAOS_STORAGE=file`)  
   `approvals.jsonl` and `dpa.jsonl` exist during runtime and show append-only mutation history for the same DPA.

3) **Smoke test passes**  
   `scripts/smoke_v0.6.sh` exits 0 and prints:  
   `SMOKE_OK: v0.6 approval queue + file persistence + transition gate`

---

## 5. Change Control

Any modification that alters:

- approval gate semantics,
- persistence format/location,
- environment gating,
- or fail-closed apply boundary,

is a constitutional breaking change and requires a new lock candidate tag and updated acceptance artifacts.

