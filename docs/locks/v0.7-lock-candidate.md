# v0.7 LOCK CANDIDATE — Ports + Approval Reducer + Fail-Closed Apply

**Repo:** proto-v2-engine  
**Branch:** v0.7-ports  
**Status:** LOCK CANDIDATE  
**Primary Goal:** Prevent runtime contract failures (e.g., AttributeError) and enforce fail-closed behavior for decision-to-apply pathways.

---

## Executive Summary

v0.7 formalizes engine-side dependency boundaries (“Ports”) and hardens approval event handling (reducer-based reads) to eliminate a class of runtime failures caused by missing methods or inconsistent queue reads.

Additionally, v0.7 introduces a default fail-closed apply port implementation and standardizes HTTP behavior such that missing/disabled apply capabilities are denied explicitly (HTTP 403) rather than failing unpredictably.

This LOCK is intended to serve as a stable baseline for subsequent production ports (DB-backed repository, real apply port, external approvals UI), while maintaining constitutional constraints: **no implicit execution, no silent bypass, and always-auditable state.**

---

## What is LOCKED in v0.7

### 1) Port Contracts (Protocol/ABC) — “Method existence is non-negotiable”
**File:** `core/judgment/ports.py`

**Locked Ports:**
- `DpaRepositoryPort`: `get/create/save`
- `ApprovalQueuePort`: `enqueue/set_status/get_latest_by_approval_id/get_latest_for_dpa`
- `DpaApplyPort`: `get_dpa/apply`

**Invariant:** Engine / router / service boundaries must depend on ports, not concrete implementations.

---

### 2) Approval Queue Reducer — “Append-only log + deterministic latest-state”
**File:** `core/judgment/persistence/approval_queue.py`

**Storage:** `approvals.jsonl` (append-only)  
**Read Rule:** Reduce events into latest state per `approval_id`

**Invariant:** Reads are reducer-derived and must not depend on “last line equals latest state” assumptions.

---

### 3) Noop Apply Port — “Fail-closed by default; no AttributeError”
**File:** `core/judgment/persistence/noop_apply_port.py`

**Behavior:**
- `get_dpa()` exists and returns `None`
- `apply()` exists and **denies** by raising `PermissionError`

**Invariant:** If a real apply port is not configured, the engine must deny apply safely (fail-closed) rather than crash or partially apply.

---

### 4) HTTP Fail-Closed Mapping — “PermissionError becomes 403”
**File:** `infra/api/routes/constitutional.py`

**Behavior:** Any `PermissionError` raised during transition is mapped to **HTTP 403**.

**Invariant:** “Apply disabled/missing” is a permission boundary, not an internal server failure.

---

## Operational Evidence (Reproducible)

**Smoke Script:** `scripts/smoke_v0.7.sh`

Expected outcome:
- Approval enqueue → approve → transition returns **HTTP 200**
- Port contract check confirms `NoopDpaApplyPort` satisfies `DpaApplyPort`

This script is the canonical runtime proof for the v0.7 LOCK candidate.

---

## Non-Goals (Explicitly Not Included)

- Real DB-backed DPA repository and migrations
- Real external approval UI or multi-authority routing
- Real apply implementation (this remains intentionally fail-closed)
- Policy/rules expansions beyond contract hardening and reducer stability

---

## Change Control

Any change to:
- Port method sets/signatures
- Reducer rules for approval state reconstruction
- Fail-closed behavior and its HTTP mapping

…must be treated as a **constitutional boundary change** requiring explicit review, updated smoke evidence, and a new LOCK candidate.

