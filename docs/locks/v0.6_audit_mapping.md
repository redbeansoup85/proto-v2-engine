# v0.6 Audit Mapping — Constitutional Invariants ↔ Code Paths

**Purpose:** Provide an audit-ready mapping from governance invariants to concrete code enforcement points.

---

## A. No-Bypass Approval Gate

**Invariant:** Approval is required for APPLY; no bypass permitted.

**Enforcement Points:**
- `infra/api/routes/constitutional.py`
  - `/v1/constitutional/transition`
  - Gate logic: requires `approval_id` when `approval.decision == "APPROVE"`
  - Resolves latest approval state via `_QUEUE` and validates:
    - APPROVED status
    - dpa_id match
    - event_id match
  - Constructs `HumanDecision` from queue and injects into request processing.

**Data Source of Truth:**
- Approval Queue:
  - `core/judgment/persistence/approval_queue.py` (file-backed)
  - `core/judgment/persistence/inmemory_queue.py` (in-memory)

---

## B. Append-Only Persistence

**Invariant:** Storage is append-only event log for DPA and approvals.

**Enforcement Points:**
- DPA persistence:
  - `core/judgment/persistence/file_repo.py`
  - Append JSONL to `var/metaos/dpa.jsonl`
- Approval queue persistence:
  - `core/judgment/persistence/approval_queue.py`
  - Append JSONL to `var/metaos/approvals.jsonl`

**Operational Control:**
- `.gitignore` excludes `var/metaos/` from version control (runtime-only data).

---

## C. Fail-Closed Apply Boundary

**Invariant:** Without explicit apply port, transition MUST fail-closed.

**Enforcement Points:**
- `core/engine/constitutional_transition.py`
  - Raises fail-closed when `dpa_apply_port` is absent or cannot perform required operations.
- DEV/LOCAL side-effect-free apply port:
  - `core/judgment/persistence/noop_apply_port.py`
  - Used only to satisfy interface requirements without side effects.

**Wiring Point:**
- `infra/api/routes/constitutional.py`
  - Conditional injection of noop apply port only for `METAOS_ENV in {"dev","local"}`.

---

## D. Debug Utilities Gating

**Invariant:** Debug-only endpoints are inaccessible in production.

**Enforcement Points:**
- `infra/api/routes/constitutional.py`
  - `__debug_seed`: allowed only when `METAOS_ENV in {"dev","local"}`

