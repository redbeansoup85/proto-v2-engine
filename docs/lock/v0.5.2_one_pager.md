# LOCK v0.5.2 — Constitutional API Bound (Transition / No-Bypass)

**Repository:** proto-v2-engine  
**Tag:** v0.5.2  
**Date:** 2026-01-16 (Australia/Sydney)

---

## What is LOCKED

### A) Constitutional Transition is a single, auditable gate
- Public API endpoint exists:
  - `POST /v1/constitutional/transition`
- Execution is allowed only through:
  - **Judgment approval (immutable)**
  - **Human decision present for APPROVE (no bypass)**
  - **DPA apply gate enforced (idempotent APPLIED)**

### B) No-bypass invariants
- If `approval.decision == "APPROVE"` **and** `human_decision is None`:
  - return **403** with `Missing human_decision (no bypass)`
- If `approval.decision == "REJECT"`:
  - return **403** with `Rejected (immutable)`

### C) DPA apply gate error transparency
- If apply is blocked by policy/transition errors:
  - returned as `PermissionError` detail preserving `(code/message/extra)` best-effort
  - without hard-coupling to judgment error types

---

## Endpoints

### 1) Transition (LOCKED)
- `POST /v1/constitutional/transition`
- Purpose: Constitutional gate → DPA apply gate → engine evaluation

### 2) Debug seed (DEV-only, gated by env)
- `POST /v1/constitutional/__debug_seed`
- Enabled only when:
  - `METAOS_ENV in ("dev","local")`
- Otherwise:
  - returns **404** `DEBUG_SEED_DISABLED`

---

## Smoke / Verification

### Primary smoke
- Script: `./scripts/smoke_v0.5.sh`
- Must pass:
  1) `pytest` suites
  2) server boot
  3) openapi includes `/v1/constitutional/transition`
  4) approve flow passes (seed → transition)
  5) reject flow blocks (403)

Expected final line:
- `[DONE] smoke_v0.5 OK`

---

## Locked Files (core surfaces)

- `core/engine/constitutional_transition.py`
  - apply-gate enforced, idempotent APPLIED semantics, no bypass
- `infra/api/routes/constitutional.py`
  - transition endpoint
  - debug seed endpoint (env gated)
- `infra/api/app.py`
  - router included
- `scripts/smoke_v0.5.sh`
  - reproducible E2E smoke for v0.5.x

---

## Out of Scope (NOT locked)
- Persistence backend (repo storage beyond in-memory)
- Production auth/rbac layer
- Domain-specific composers/plugins (beyond minimal composer)
- Approval queue externalization

---

## Acceptance Criteria (Immutable Invariants)

다음 항목 중 **하나라도 위반되면 LOCK v0.5.2는 깨진다.**

### AC-1. Single Constitutional Gate
- Engine 실행 경로는 **오직**
  - `POST /v1/constitutional/transition`
- 직접 `run_engine()` 호출 경로는 외부에 존재하면 안 된다.

### AC-2. No Human-Decision Bypass
- 조건:
  - `approval.decision == "APPROVE"`
  - `human_decision == null`
- 결과:
  - **403 Forbidden**
  - 메시지: `Missing human_decision (no bypass)`

### AC-3. Immutable Reject
- 조건:
  - `approval.decision == "REJECT"`
- 결과:
  - **항상 403**
  - 이후 어떤 입력으로도 실행 불가 (terminal)

### AC-4. DPA Apply Gate Enforcement
- Engine 실행 전 반드시:
  - `DPA.status == APPLIED`
- 허용:
  - 이미 `APPLIED` 인 경우 (idempotent)
- 금지:
  - `APPROVED` 또는 그 이전 상태에서 engine 실행

### AC-5. Error Transparency (No Silent Fail)
- DPA apply 중 오류 발생 시:
  - **PermissionError로 승격**
  - 오류 코드/메시지/extra 정보 최대 보존
- try/except로 조용히 통과하면 **LOCK 위반**

### AC-6. Debug Endpoint Isolation
- `/v1/constitutional/__debug_seed`
- 허용 환경:
  - `METAOS_ENV=dev|local`
- 그 외:
  - **404 DEBUG_SEED_DISABLED**

### AC-7. Reproducible Smoke
- `./scripts/smoke_v0.5.sh`
- 반드시 검증해야 할 흐름:
  1) approve → 실행 성공
  2) reject → 403
  3) approve + human_decision 없음 → 403
- 하나라도 실패 시 LOCK 위반

---

## LOCK Statement

이 문서는 **설계 설명서가 아니라 계약서**이다.  
본 LOCK 이후의 변경은 반드시:

1. 새 버전 태그
2. 새로운 Acceptance Criteria
3. 별도 LOCK 문서

를 통해서만 허용된다.
